# TCP 面试题
[[toc]]

## 三次握手
三次握手（Three-way Handshake）其实就是指建立一个TCP连接时，需要客户端和服务器总共发送3个包

作用：就是为了确认双方的接收能力和发送能力是否正常、指定自己的初始化序列号为后面的可靠性传送做准备

- 服务端调用 `listen` 系统命令，进入监听状态，等待客户端的连接。
- 客户端向服务端发送连接请求报文，其中 `TCP` 标志位里`SYN=1`，`ACK=0`，选择一个初始的序号x。
    > ACK中的，1：表示确认号有效；0：报文中不包含确认信息
- 服务端收到请求报文，向客户端发送连接确认报文，`SYN=1`，`ACK=1`，确认号为 `x+1`，同时也选择一个初始的序号 `y`。
- 客户端 收到服务端的连接确认报文后，还要向服务端发出确认，确认号为 `y+1`，序号为 `x+1`。
- 服务端 收到客户端的确认后，连接建立。

## 为什么需要三次握手，两次不行吗？

第三次握手是为了`防止失效的连接请求到达服务器，让服务器错误打开连接`。

弄清这个问题，我们需要先弄明白三次握手的目的是什么，能不能只用两次握手来达到同样的目的
- 第一次握手：客户端发送网络包，服务端收到了。这样服务端就能得出结论：客户端的发送能力、服务端的接收能力是正常的
- 第二次握手：服务端发包，客户端收到了。这样客户端就能得出结论：服务端的接收、发送能力，客户端的接收、发送能力是正常的。不过此时服务器并不能确认客户端的接收能力是否正常
- 第三次握手：客户端发包，服务端收到了。这样服务端就能得出结论：客户端的接收、发送能力正常，服务器自己的发送、接收能力也正常

因此，需要三次握手才能确认双方的接收与发送能力是否正常。

## 什么是半连接队列？
服务器第一次收到客户端的 `SYN` 之后，就会处于 `SYN_RCVD` 状态，此时双方还没有完全建立其连接，服务器会把此种状态下请求连接放在一个队列里，我们把这种队列称之为半连接队列


## SYN 攻击是什么？
`SYN` 攻击属于 `DDoS` 攻击的一种，它利用 `TCP` 协议缺陷，通过发送大量的半连接请求，耗费 `CPU` 和内存资源。`SYN` 攻击除了能影响主机外，还可以危害路由器、防火墙等网络系统，事实上 `SYN` 攻击并不管目标是什么系统，只要这些系统打开 `TCP` 服务就可以实施


## 四次挥手
1. `TCP` 客户端发送一个`FIN`，用来关闭客户到服务器的数据传送。
2. 服务器收到这个`FIN`，它发回一个`ACK`，确认序号为收到的序号加1
3. 服务器关闭客户端的连接，发送一个 `FIN` 给客户端。
4. 客户端发回 `ACK` 报文确认，并将确认序号设置为收到序号加1。



